{% extends 'base.html' %}
{% load static %}

{% block title %}Extracted Findings - ShareMyCare{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Extracted Findings from Therapist Notes</h1>
        <p class="page-subtitle">Assessment: {{ assessment.assessment_date|date:"F d, Y"|default:"N/A" }}</p>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>Assessment Details</h2>
        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Patient:</label>
                    <span>{{ assessment.user.get_full_name|default:assessment.user.username }}</span>
                </div>
                <div class="info-item">
                    <label>Assessment Date:</label>
                    <span>{{ assessment.assessment_date|date:"F d, Y"|default:"N/A" }}</span>
                </div>
                {% if assessment.clinician %}
                <div class="info-item">
                    <label>Clinician:</label>
                    <span>{{ assessment.clinician.full_name }}</span>
                </div>
                {% endif %}
                {% if assessment.assessment_type %}
                <div class="info-item">
                    <label>Type:</label>
                    <span>{{ assessment.get_assessment_type_display }}</span>
                </div>
                {% endif %}
            </div>
            
            {% if assessment.practitioner_notes_image %}
            <div class="notes-image-section">
                <h3>Original Notes Image</h3>
                <img src="{{ assessment.practitioner_notes_image.url }}" alt="Practitioner Notes" class="notes-image-preview">
                <div class="action-buttons">
                    <a href="{% url 'health_records:process_notes_image' assessment.pk %}" class="btn btn-primary">
                        üîÑ Re-process Notes
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if findings %}
    <div class="card">
        <div class="card-header">
            <h2>Extracted Findings</h2>
            <span class="badge badge-primary">{{ findings|length }} finding{{ findings|length|pluralize }}</span>
        </div>
        <div class="card-body">
            {% for category, category_findings in findings_by_category.items %}
            <div class="findings-category">
                <h3 class="category-title">{{ category }}</h3>
                <div class="table-responsive">
                    <table class="findings-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Finding</th>
                                <th>Extracted</th>
                                {% if is_clinician %}
                                <th>Status</th>
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for finding in category_findings %}
                            <tr class="{% if finding.is_verified %}finding-verified{% endif %}">
                                <td>
                                    <span class="finding-type-badge finding-type-{{ finding.finding_type }}">
                                        {{ finding.get_finding_type_display }}
                                    </span>
                                </td>
                                <td class="finding-text">{{ finding.text }}</td>
                                <td class="finding-date">{{ finding.extracted_at|date:"M d, Y H:i" }}</td>
                                {% if is_clinician %}
                                <td>
                                    {% if finding.is_verified %}
                                        <span class="badge badge-success">
                                            ‚úì Verified
                                            {% if finding.verified_by %}
                                                by {{ finding.verified_by.full_name }}
                                            {% endif %}
                                        </span>
                                    {% else %}
                                        <span class="badge badge-warning">Pending Verification</span>
                                    {% endif %}
                                </td>
                                <td class="finding-actions">
                                    <a href="{% url 'health_records:verify_finding' finding.pk %}" 
                                       class="btn-icon btn-icon-sm {% if finding.is_verified %}btn-icon-warning{% else %}btn-icon-success{% endif %}"
                                       title="{% if finding.is_verified %}Unverify{% else %}Verify{% endif %}">
                                        {% if finding.is_verified %}‚úó{% else %}‚úì{% endif %}
                                    </a>
                                    <a href="{% url 'health_records:delete_finding' finding.pk %}" 
                                       class="btn-icon btn-icon-sm btn-icon-danger"
                                       title="Delete"
                                       onclick="return confirm('Are you sure you want to delete this finding?');">
                                        üóëÔ∏è
                                    </a>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body">
            <div class="empty-state">
                <p>No findings have been extracted yet.</p>
                {% if has_image %}
                <a href="{% url 'health_records:process_notes_image' assessment.pk %}" class="btn btn-primary">
                    Process Notes Image
                </a>
                {% else %}
                <p class="text-muted">Upload a notes image first to extract findings.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="action-buttons">
        {% if is_clinician %}
        <a href="{% url 'clinicians:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        {% else %}
        <a href="{% url 'health_records:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        {% endif %}
    </div>
</div>

<style>
.findings-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.findings-table th,
.findings-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.findings-table th {
    background-color: #f5f5f5;
    font-weight: 600;
    color: #333;
}

.findings-table tbody tr:hover {
    background-color: #f9f9f9;
}

.finding-verified {
    background-color: #f0f9ff;
}

.finding-text {
    max-width: 500px;
    word-wrap: break-word;
}

.finding-type-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
}

.finding-type-measurement {
    background-color: #e3f2fd;
    color: #1976d2;
}

.finding-type-strength {
    background-color: #fff3e0;
    color: #f57c00;
}

.finding-type-symptom {
    background-color: #fce4ec;
    color: #c2185b;
}

.finding-type-treatment {
    background-color: #e8f5e9;
    color: #388e3c;
}

.finding-type-observation {
    background-color: #f3e5f5;
    color: #7b1fa2;
}

.findings-category {
    margin-bottom: 2rem;
}

.category-title {
    margin-bottom: 1rem;
    color: #333;
    font-size: 1.25rem;
}

.notes-image-section {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e0e0e0;
}

.notes-image-preview {
    max-width: 100%;
    max-height: 400px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    margin: 1rem 0;
}

.finding-actions {
    white-space: nowrap;
}

.btn-icon-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    margin: 0 0.25rem;
}
</style>
{% endblock %}

