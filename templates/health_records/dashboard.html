{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - ShareMyCare{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Your Health Dashboard</h1>
        <p class="dashboard-subtitle">Welcome back, {{ user.get_full_name|default:user.username }}!</p>
        <div class="dashboard-header-actions">
            <a href="{% url 'health_records:invite_clinician' %}" class="btn btn-primary btn-header">Share with Clinicians</a>
        </div>
    </div>


    <div class="dashboard-grid">
        <!-- Medications Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title-group">
                    <img src="{% static 'images/meds.png' %}" alt="Medications" class="card-icon">
                    <div>
                        <h2 class="card-title">Medications</h2>
                        <p class="card-count">{{ medications.count }} medication{{ medications.count|pluralize }}</p>
                    </div>
                </div>
                <a href="{% url 'health_records:add_medication' %}" class="btn btn-primary btn-sm">Add +</a>
            </div>
            <div class="card-content">
                {% if medications %}
                    <div class="items-list">
                        {% for medication in medications|slice:":3" %}
                            <div class="item-row">
                                <div class="item-info">
                                    <div class="item-header">
                                        <h4>{{ medication.name }}</h4>
                                        {% if medication.prescription_image %}
                                            <span class="prescription-badge" title="Prescription image available">üì∑</span>
                                        {% endif %}
                                    </div>
                                    <p class="item-details">
                                        {% if medication.dosage %}{{ medication.dosage }}{% endif %}
                                        {% if medication.frequency %} ‚Ä¢ {{ medication.frequency }}{% endif %}
                                    </p>
                                    <div class="item-badges">
                                        {% if medication.is_active %}
                                            <span class="badge badge-success">Active</span>
                                        {% else %}
                                            <span class="badge badge-secondary">Inactive</span>
                                        {% endif %}
                                        {% if medication.is_prescribed %}
                                            <span class="badge badge-primary">Prescribed</span>
                                        {% else %}
                                            <span class="badge badge-info">Non-prescribed</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <a href="{% url 'health_records:edit_medication' medication.pk %}" class="btn-icon" title="Edit">‚úèÔ∏è</a>
                                    <a href="{% url 'health_records:delete_medication' medication.pk %}" class="btn-icon btn-icon-danger" title="Delete">üóëÔ∏è</a>
                                </div>
                            </div>
                        {% endfor %}
                        {% if medications.count > 3 %}
                            <p class="more-items">+ {{ medications.count|add:"-3" }} more medication{{ medications.count|add:"-3"|pluralize }}</p>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>No medications added yet.</p>
                        <a href="{% url 'health_records:add_medication' %}" class="btn btn-secondary btn-sm">Add Your First Medication</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Conditions Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title-group">
                    <img src="{% static 'images/healthrecords.png' %}" alt="Conditions" class="card-icon">
                    <div>
                        <h2 class="card-title">Conditions</h2>
                        <p class="card-count">{{ conditions.count }} condition{{ conditions.count|pluralize }}</p>
                    </div>
                </div>
                <a href="{% url 'health_records:add_condition' %}" class="btn btn-primary btn-sm">Add +</a>
            </div>
            <div class="card-content">
                {% if conditions %}
                    <div class="items-list">
                        {% for condition in conditions|slice:":3" %}
                            <div class="item-row">
                                <div class="item-info">
                                    <h4>{{ condition.name }}</h4>
                                    <p class="item-details">
                                        {% if condition.diagnosis_date %}Diagnosed: {{ condition.diagnosis_date|date:"M Y" }}{% endif %}
                                    </p>
                                    <div class="item-badges">
                                        <span class="badge badge-{{ condition.status }}">{{ condition.get_status_display }}</span>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <a href="{% url 'health_records:edit_condition' condition.pk %}" class="btn-icon" title="Edit">‚úèÔ∏è</a>
                                    <a href="{% url 'health_records:delete_condition' condition.pk %}" class="btn-icon btn-icon-danger" title="Delete">üóëÔ∏è</a>
                                </div>
                            </div>
                        {% endfor %}
                        {% if conditions.count > 3 %}
                            <p class="more-items">+ {{ conditions.count|add:"-3" }} more condition{{ conditions.count|add:"-3"|pluralize }}</p>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>No conditions added yet.</p>
                        <a href="{% url 'health_records:add_condition' %}" class="btn btn-secondary btn-sm">Add Your First Condition</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Allergies Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title-group">
                    <div class="card-icon-emoji">‚ö†Ô∏è</div>
                    <div>
                        <h2 class="card-title">Allergies</h2>
                        <p class="card-count">{{ allergies.count }} allerg{{ allergies.count|pluralize:"y,ies" }}</p>
                    </div>
                </div>
                <a href="{% url 'health_records:add_allergy' %}" class="btn btn-primary btn-sm">Add +</a>
            </div>
            <div class="card-content">
                {% if allergies %}
                    <div class="items-list">
                        {% for allergy in allergies|slice:":3" %}
                            <div class="item-row">
                                <div class="item-info">
                                    <h4>{{ allergy.allergen }}</h4>
                                    <p class="item-details">{{ allergy.reaction|truncatewords:10 }}</p>
                                    <div class="item-badges">
                                        <span class="badge badge-severity-{{ allergy.severity }}">{{ allergy.get_severity_display }}</span>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <a href="{% url 'health_records:edit_allergy' allergy.pk %}" class="btn-icon" title="Edit">‚úèÔ∏è</a>
                                    <a href="{% url 'health_records:delete_allergy' allergy.pk %}" class="btn-icon btn-icon-danger" title="Delete">üóëÔ∏è</a>
                                </div>
                            </div>
                        {% endfor %}
                        {% if allergies.count > 3 %}
                            <p class="more-items">+ {{ allergies.count|add:"-3" }} more allerg{{ allergies.count|add:"-3"|pluralize:"y,ies" }}</p>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>No allergies recorded yet.</p>
                        <a href="{% url 'health_records:add_allergy' %}" class="btn btn-secondary btn-sm">Add Your First Allergy</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Assessments Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title-group">
                    <div class="card-icon-emoji">üìã</div>
                    <div>
                        <h2 class="card-title">Assessments</h2>
                        <p class="card-count">{{ assessments.count }} assessment{{ assessments.count|pluralize }}</p>
                    </div>
                </div>
                <a href="{% url 'health_records:add_assessment' %}" class="btn btn-primary btn-sm">Add +</a>
            </div>
            <div class="card-content">
                {% if assessments %}
                    <div class="items-list">
                        {% for assessment in assessments|slice:":3" %}
                            <div class="item-row">
                                <div class="item-info">
                                    <div class="item-header">
                                        <h4>
                                            {% if assessment.symptom_date %}
                                                {{ assessment.symptom_date|date:"d M Y" }}
                                            {% elif assessment.assessment_date %}
                                                {{ assessment.assessment_date|date:"d M Y" }}
                                            {% else %}
                                                Assessment
                                            {% endif %}
                                        </h4>
                                        {% if assessment.has_practitioner_data %}
                                            <span class="practitioner-badge" title="Practitioner assessment available">üë®‚Äç‚öïÔ∏è</span>
                                        {% endif %}
                                    </div>
                                    <p class="item-details">
                                        {% if assessment.current_symptoms %}
                                            {{ assessment.current_symptoms|truncatewords:15 }}
                                        {% elif assessment.pain_level is not None %}
                                            Pain Level: {{ assessment.pain_level }}/10
                                        {% else %}
                                            Assessment entry
                                        {% endif %}
                                    </p>
                                    <div class="item-badges">
                                        {% if assessment.pain_level is not None %}
                                            <span class="badge badge-pain-{{ assessment.pain_level|floatformat:0 }}">Pain: {{ assessment.pain_level }}/10</span>
                                        {% endif %}
                                        {% if assessment.has_practitioner_data %}
                                            <span class="badge badge-primary">Practitioner Assessment</span>
                                        {% endif %}
                                        {% if assessment.practitioner_notes_image %}
                                            <span class="prescription-badge" title="Practitioner notes photo available">üì∑</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button type="button" class="btn-open" onclick='openAssessmentModal({{ assessment.pk }}, "{{ assessment.symptom_date|date:"d M Y"|default:"Assessment" }}", `{{ assessment.current_symptoms|escapejs }}`, `{{ assessment.previous_symptoms|escapejs }}`, `{{ assessment.condition_progression|escapejs }}`, "{{ assessment.pain_level|default:"" }}", `{{ assessment.objective_findings|escapejs }}`, `{{ assessment.treatment_plan|escapejs }}`, `{{ assessment.practitioner_notes|escapejs }}`, {{ assessment.has_practitioner_data|yesno:"true,false" }})'>Open</button>
                                    <a href="{% url 'health_records:delete_assessment' assessment.pk %}" class="btn-icon btn-icon-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this assessment? Your clinicians will be notified of the deletion.');">üóëÔ∏è</a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if assessments.count > 3 %}
                        <!-- Show All Button -->
                        <div style="margin-top: var(--spacing-sm); text-align: center;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleAllAssessments()" id="toggleAssessmentsBtn">
                                Show All {{ assessments.count }} Assessments
                            </button>
                        </div>
                        
                        <!-- Hidden Assessments -->
                        <div class="items-list" id="hiddenAssessments" style="display: none; margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: 1px solid var(--border-color);">
                            {% for assessment in assessments|slice:"3:" %}
                                <div class="item-row">
                                    <div class="item-info">
                                        <div class="item-header">
                                            <h4>
                                                {% if assessment.symptom_date %}
                                                    {{ assessment.symptom_date|date:"d M Y" }}
                                                {% elif assessment.assessment_date %}
                                                    {{ assessment.assessment_date|date:"d M Y" }}
                                                {% else %}
                                                    Assessment
                                                {% endif %}
                                            </h4>
                                            {% if assessment.has_practitioner_data %}
                                                <span class="practitioner-badge" title="Practitioner assessment available">üë®‚Äç‚öïÔ∏è</span>
                                            {% endif %}
                                        </div>
                                        <p class="item-details">
                                            {% if assessment.current_symptoms %}
                                                {{ assessment.current_symptoms|truncatewords:15 }}
                                            {% elif assessment.pain_level is not None %}
                                                Pain Level: {{ assessment.pain_level }}/10
                                            {% else %}
                                                Assessment entry
                                            {% endif %}
                                        </p>
                                        <div class="item-badges">
                                            {% if assessment.pain_level is not None %}
                                                <span class="badge badge-pain-{{ assessment.pain_level|floatformat:0 }}">Pain: {{ assessment.pain_level }}/10</span>
                                            {% endif %}
                                            {% if assessment.has_practitioner_data %}
                                                <span class="badge badge-primary">Practitioner Assessment</span>
                                            {% endif %}
                                            {% if assessment.practitioner_notes_image %}
                                                <span class="prescription-badge" title="Practitioner notes photo available">üì∑</span>
                                                {% if assessment.extracted_findings.exists %}
                                                    <button type="button" class="badge badge-info" title="View extracted findings" onclick="showFindingsModal({{ assessment.pk }})">üìã Findings</button>
                                                {% else %}
                                                    <button type="button" class="badge badge-primary" title="Extract findings from notes" onclick="extractAndShowFindings({{ assessment.pk }})">üîç Extract</button>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="item-actions">
                                        <button type="button" class="btn-open" onclick='openAssessmentModal({{ assessment.pk }}, "{{ assessment.symptom_date|date:"d M Y"|default:"Assessment" }}", `{{ assessment.current_symptoms|escapejs }}`, `{{ assessment.previous_symptoms|escapejs }}`, `{{ assessment.condition_progression|escapejs }}`, "{{ assessment.pain_level|default:"" }}", `{{ assessment.objective_findings|escapejs }}`, `{{ assessment.treatment_plan|escapejs }}`, `{{ assessment.practitioner_notes|escapejs }}`, {{ assessment.has_practitioner_data|yesno:"true,false" }})'>Open</button>
                                        <a href="{% url 'health_records:delete_assessment' assessment.pk %}" class="btn-icon btn-icon-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this assessment? Your clinicians will be notified of the deletion.');">üóëÔ∏è</a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="empty-state">
                        <p>No assessments recorded yet.</p>
                        <a href="{% url 'health_records:add_assessment' %}" class="btn btn-secondary btn-sm">Add Your First Assessment</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Share with Clinicians Section - Prominent Position -->
        <div class="dashboard-card clinician-share-card">
            <div class="card-header">
                <div class="card-title-group">
                    <div class="card-icon-emoji">üë®‚Äç‚öïÔ∏è</div>
                    <div>
                        <h2 class="card-title">Share with Clinicians</h2>
                        <p class="card-count">{{ clinician_accesses.count }} clinician{{ clinician_accesses.count|pluralize }} with access</p>
                    </div>
                </div>
                <a href="{% url 'health_records:invite_clinician' %}" class="btn btn-primary btn-sm">Invite +</a>
            </div>
            <div class="card-content">
                {% if clinician_accesses %}
                    <div class="items-list">
                        {% for access in clinician_accesses|slice:":3" %}
                            <div class="item-row">
                                <div class="item-info">
                                    <h4>{{ access.clinician.full_name }}</h4>
                                    <p class="item-details">
                                        {% if access.clinician.organisation %}{{ access.clinician.organisation }}{% endif %}
                                        {% if access.clinician.speciality %} ‚Ä¢ {{ access.clinician.speciality }}{% endif %}
                                    </p>
                                    <div class="item-badges">
                                        <span class="badge badge-{{ access.access_level }}">{{ access.get_access_level_display }}</span>
                                        {% if access.consent_given_at %}
                                            <span class="badge badge-info">Access granted {{ access.consent_given_at|date:"M Y" }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <a href="{% url 'health_records:revoke_clinician_access' access.pk %}" class="btn-icon btn-icon-danger" title="Revoke Access">üö´</a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% if clinician_accesses.count > 3 %}
                        <div style="margin-top: var(--spacing-sm); text-align: center;">
                            <a href="{% url 'health_records:invite_clinician' %}" class="btn btn-secondary btn-sm">View All & Manage</a>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="empty-state">
                        <p>No clinicians have access yet.</p>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Invite healthcare professionals to view your records and add objective assessments.
                        </p>
                        <a href="{% url 'health_records:invite_clinician' %}" class="btn btn-primary btn-sm" style="margin-top: var(--spacing-sm);">Invite a Clinician</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Personal Information Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title-group">
                    <div class="card-icon-emoji">üë§</div>
                    <div>
                        <h2 class="card-title">Personal Information</h2>
                    </div>
                </div>
                <a href="{% url 'health_records:edit_profile' %}" class="btn btn-primary btn-sm">Edit</a>
            </div>
            <div class="card-content">
                <div class="profile-info">
                    <div class="info-row">
                        <span class="info-label">Date of Birth:</span>
                        <span class="info-value">{% if profile.date_of_birth %}{{ profile.date_of_birth|date:"d M Y" }}{% else %}Not set{% endif %}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Phone Number:</span>
                        <span class="info-value">{% if profile.phone_number %}{{ profile.phone_number }}{% else %}Not set{% endif %}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Work Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title-group">
                    <div class="card-icon-emoji">üíº</div>
                    <div>
                        <h2 class="card-title">Current Work</h2>
                        <p class="card-count">{{ current_work.count }} job{{ current_work.count|pluralize }}</p>
                    </div>
                </div>
                <a href="{% url 'health_records:add_work_history' %}" class="btn btn-primary btn-sm">Add +</a>
            </div>
            <div class="card-content">
                {% if current_work %}
                    <div class="items-list">
                        {% for work in current_work|slice:":3" %}
                            <div class="item-row">
                                <div class="item-info">
                                    <h4>{{ work.job_title }}</h4>
                                    <p class="item-details">
                                        {% if work.employer %}{{ work.employer }} ‚Ä¢ {% endif %}
                                        Since {{ work.start_date|date:"M Y" }}
                                        {% if work.hours_per_week %} ‚Ä¢ {{ work.hours_per_week }} hrs/week{% endif %}
                                    </p>
                                    {% if work.activities %}
                                        <div class="item-badges">
                                            {% for activity in work.get_activities_display %}
                                                <span class="badge badge-info">{{ activity }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="item-actions">
                                    <a href="{% url 'health_records:edit_work_history' work.pk %}" class="btn-icon" title="Edit">‚úèÔ∏è</a>
                                    <a href="{% url 'health_records:delete_work_history' work.pk %}" class="btn-icon btn-icon-danger" title="Delete">üóëÔ∏è</a>
                                </div>
                            </div>
                        {% endfor %}
                        {% if current_work.count > 3 %}
                            <p class="more-items">+ {{ current_work.count|add:"-3" }} more job{{ current_work.count|add:"-3"|pluralize }}</p>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>No current work recorded yet.</p>
                        <a href="{% url 'health_records:add_work_history' %}" class="btn btn-secondary btn-sm">Add Your Current Work</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Previous Work Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title-group">
                    <div class="card-icon-emoji">üìã</div>
                    <div>
                        <h2 class="card-title">Previous Work</h2>
                        <p class="card-count">{{ previous_work.count }} job{{ previous_work.count|pluralize }}</p>
                    </div>
                </div>
                <a href="{% url 'health_records:add_work_history' %}" class="btn btn-primary btn-sm">Add +</a>
            </div>
            <div class="card-content">
                {% if previous_work %}
                    <div class="items-list">
                        {% for work in previous_work|slice:":3" %}
                            <div class="item-row">
                                <div class="item-info">
                                    <h4>{{ work.job_title }}</h4>
                                    <p class="item-details">
                                        {% if work.employer %}{{ work.employer }} ‚Ä¢ {% endif %}
                                        {{ work.start_date|date:"M Y" }} - {% if work.end_date %}{{ work.end_date|date:"M Y" }}{% else %}Present{% endif %}
                                        {% if work.hours_per_week %} ‚Ä¢ {{ work.hours_per_week }} hrs/week{% endif %}
                                    </p>
                                    {% if work.activities %}
                                        <div class="item-badges">
                                            {% for activity in work.get_activities_display %}
                                                <span class="badge badge-info">{{ activity }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="item-actions">
                                    <a href="{% url 'health_records:edit_work_history' work.pk %}" class="btn-icon" title="Edit">‚úèÔ∏è</a>
                                    <a href="{% url 'health_records:delete_work_history' work.pk %}" class="btn-icon btn-icon-danger" title="Delete">üóëÔ∏è</a>
                                </div>
                            </div>
                        {% endfor %}
                        {% if previous_work.count > 3 %}
                            <p class="more-items">+ {{ previous_work.count|add:"-3" }} more job{{ previous_work.count|add:"-3"|pluralize }}</p>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>No previous work recorded yet.</p>
                        <a href="{% url 'health_records:add_work_history' %}" class="btn btn-secondary btn-sm">Add Previous Work</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Healthcare Feedback Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title-group">
                    <div class="card-icon-emoji">üí¨</div>
                    <div>
                        <h2 class="card-title">Healthcare Feedback</h2>
                        <p class="card-count">{{ feedback.count }} feedback entr{{ feedback.count|pluralize:"y,ies" }}</p>
                    </div>
                </div>
                <a href="{% url 'health_records:add_feedback' %}" class="btn btn-primary btn-sm">Add +</a>
            </div>
            <div class="card-content">
                {% if feedback %}
                    <div class="items-list">
                        {% for item in feedback|slice:":3" %}
                            <div class="item-row">
                                <div class="item-info">
                                    <h4>{{ item.organisation }}</h4>
                                    <p class="item-details">
                                        {{ item.get_feedback_type_display }} ‚Ä¢ 
                                        {{ item.created_at|date:"d M Y" }}
                                        {% if item.is_anonymous %} ‚Ä¢ Anonymous{% endif %}
                                    </p>
                                    <div class="item-badges">
                                        <span class="badge badge-rating-{{ item.rating }}">‚≠ê {{ item.rating }}/5</span>
                                        {% if item.is_private %}
                                            <span class="badge badge-info">Private</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <a href="{% url 'health_records:delete_feedback' item.pk %}" class="btn-icon btn-icon-danger" title="Delete">üóëÔ∏è</a>
                                </div>
                            </div>
                        {% endfor %}
                        {% if feedback.count > 3 %}
                            <p class="more-items">+ {{ feedback.count|add:"-3" }} more entr{{ feedback.count|add:"-3"|pluralize:"y,ies" }}</p>
                        {% endif %}
                        <div style="margin-top: var(--spacing-sm);">
                            <a href="{% url 'health_records:view_feedback' %}" class="btn btn-secondary btn-sm">View All Feedback</a>
                        </div>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>No feedback submitted yet.</p>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Share your experience with healthcare organizations (feedback is private and linked to organizations, not individual HCPs).
                        </p>
                        {% if clinician_accesses %}
                            <div style="margin-top: var(--spacing-sm);">
                                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Quick feedback for organizations you've worked with:</p>
                                {% for access in clinician_accesses|slice:":3" %}
                                    {% if access.clinician.organisation %}
                                        <a href="{% url 'health_records:add_feedback_for_access' access.pk %}" class="btn btn-secondary btn-sm" style="margin: 0.25rem; display: inline-block;">
                                            Feedback: {{ access.clinician.organisation }}
                                        </a>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <a href="{% url 'health_records:add_feedback' %}" class="btn btn-primary btn-sm" style="margin-top: var(--spacing-sm);">Submit General Feedback</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Emergency Contacts Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title-group">
                    <div class="card-icon-emoji">üö®</div>
                    <div>
                        <h2 class="card-title">Emergency Contacts</h2>
                    </div>
                </div>
                <a href="{% url 'health_records:edit_profile' %}" class="btn btn-primary btn-sm">Edit</a>
            </div>
            <div class="card-content">
                <div class="profile-info">
                    {% if profile.emergency_contact_name %}
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value">{{ profile.emergency_contact_name }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Relationship:</span>
                            <span class="info-value">{{ profile.emergency_contact_relationship|default:"Not specified" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">{{ profile.emergency_contact_phone }}</span>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <p>No emergency contact set.</p>
                            <a href="{% url 'health_records:edit_profile' %}" class="btn btn-secondary btn-sm">Add Emergency Contact</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Details Modal -->
<div id="assessmentModal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeAssessmentModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Assessment Details</h2>
            <button type="button" class="modal-close" onclick="closeAssessmentModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <!-- Patient Symptoms Section -->
            <div class="modal-section" id="patientSection">
                <h3 class="modal-section-title">Patient-Reported Symptoms</h3>
                
                <div class="modal-field" id="currentSymptomsField" style="display: none;">
                    <label>Current Symptoms:</label>
                    <div class="modal-value" id="currentSymptoms"></div>
                </div>
                
                <div class="modal-field" id="previousSymptomsField" style="display: none;">
                    <label>Previous Symptoms:</label>
                    <div class="modal-value" id="previousSymptoms"></div>
                </div>
                
                <div class="modal-field" id="progressionField" style="display: none;">
                    <label>Condition Progression:</label>
                    <div class="modal-value" id="conditionProgression"></div>
                </div>
                
                <div class="modal-field" id="painLevelField" style="display: none;">
                    <label>Pain Level:</label>
                    <div class="modal-value" id="painLevel"></div>
                </div>
            </div>
            
            <!-- Practitioner Assessment Section -->
            <div class="modal-section" id="practitionerSection" style="display: none;">
                <h3 class="modal-section-title">Practitioner Assessment</h3>
                
                <div class="modal-field" id="objectiveFindingsField" style="display: none;">
                    <label>Objective Findings:</label>
                    <div class="modal-value" id="objectiveFindings"></div>
                </div>
                
                <div class="modal-field" id="treatmentPlanField" style="display: none;">
                    <label>Treatment Plan:</label>
                    <div class="modal-value" id="treatmentPlan"></div>
                </div>
                
                <div class="modal-field" id="practitionerNotesField" style="display: none;">
                    <label>Practitioner Notes:</label>
                    <div class="modal-value" id="practitionerNotes"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAssessmentModal()">Close</button>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal-content {
    position: relative;
    background: white;
    border-radius: var(--radius-lg);
    max-width: 700px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    z-index: 1001;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    padding: var(--spacing-md);
    border-bottom: 2px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, rgba(0, 113, 227, 0.05) 0%, rgba(32, 178, 170, 0.05) 100%);
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: rgba(0, 0, 0, 0.05);
    color: var(--text-primary);
}

.modal-body {
    padding: var(--spacing-md);
}

.modal-section {
    margin-bottom: var(--spacing-lg);
}

.modal-section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 var(--spacing-md) 0;
    padding-bottom: var(--spacing-xs);
    border-bottom: 2px solid var(--border-color);
}

.modal-field {
    margin-bottom: var(--spacing-md);
}

.modal-field label {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.375rem;
    font-size: 0.9375rem;
}

.modal-value {
    padding: var(--spacing-sm);
    background: var(--bg-light);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--primary-color);
    color: var(--text-primary);
    line-height: 1.6;
    white-space: pre-wrap;
}

.modal-footer {
    padding: var(--spacing-md);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-sm);
}

.btn-open {
    padding: 0.375rem 0.75rem;
    background: linear-gradient(135deg, var(--healthcare-primary) 0%, var(--primary-color) 100%);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 113, 227, 0.25);
}

.btn-open:hover {
    background: linear-gradient(135deg, var(--healthcare-primary-hover) 0%, var(--primary-hover) 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 113, 227, 0.35);
}

@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        max-height: 90vh;
    }
}
</style>

<script>
function toggleAllAssessments() {
    const hiddenSection = document.getElementById('hiddenAssessments');
    const btn = document.getElementById('toggleAssessmentsBtn');
    
    if (hiddenSection.style.display === 'none') {
        hiddenSection.style.display = 'block';
        btn.textContent = 'Show Less';
    } else {
        hiddenSection.style.display = 'none';
        const count = {{ assessments.count }};
        btn.textContent = `Show All ${count} Assessments`;
    }
}

function openAssessmentModal(id, date, currentSymptoms, previousSymptoms, progression, painLevel, objectiveFindings, treatmentPlan, practitionerNotes, hasPractitionerData) {
    // Set modal title
    document.getElementById('modalTitle').textContent = 'Assessment - ' + date;
    
    // Patient Symptoms Section
    let hasPatientData = false;
    
    // Current Symptoms
    if (currentSymptoms && currentSymptoms.trim()) {
        document.getElementById('currentSymptoms').textContent = currentSymptoms;
        document.getElementById('currentSymptomsField').style.display = 'block';
        hasPatientData = true;
    } else {
        document.getElementById('currentSymptomsField').style.display = 'none';
    }
    
    // Previous Symptoms
    if (previousSymptoms && previousSymptoms.trim()) {
        document.getElementById('previousSymptoms').textContent = previousSymptoms;
        document.getElementById('previousSymptomsField').style.display = 'block';
        hasPatientData = true;
    } else {
        document.getElementById('previousSymptomsField').style.display = 'none';
    }
    
    // Condition Progression
    if (progression && progression.trim()) {
        document.getElementById('conditionProgression').textContent = progression;
        document.getElementById('progressionField').style.display = 'block';
        hasPatientData = true;
    } else {
        document.getElementById('progressionField').style.display = 'none';
    }
    
    // Pain Level
    if (painLevel && painLevel.trim()) {
        document.getElementById('painLevel').textContent = painLevel + '/10';
        document.getElementById('painLevelField').style.display = 'block';
        hasPatientData = true;
    } else {
        document.getElementById('painLevelField').style.display = 'none';
    }
    
    // Show/hide patient section
    document.getElementById('patientSection').style.display = hasPatientData ? 'block' : 'none';
    
    // Practitioner Assessment Section
    let hasPractitionerInfo = false;
    
    // Objective Findings
    if (objectiveFindings && objectiveFindings.trim()) {
        document.getElementById('objectiveFindings').textContent = objectiveFindings;
        document.getElementById('objectiveFindingsField').style.display = 'block';
        hasPractitionerInfo = true;
    } else {
        document.getElementById('objectiveFindingsField').style.display = 'none';
    }
    
    // Treatment Plan
    if (treatmentPlan && treatmentPlan.trim()) {
        document.getElementById('treatmentPlan').textContent = treatmentPlan;
        document.getElementById('treatmentPlanField').style.display = 'block';
        hasPractitionerInfo = true;
    } else {
        document.getElementById('treatmentPlanField').style.display = 'none';
    }
    
    // Practitioner Notes
    if (practitionerNotes && practitionerNotes.trim()) {
        document.getElementById('practitionerNotes').textContent = practitionerNotes;
        document.getElementById('practitionerNotesField').style.display = 'block';
        hasPractitionerInfo = true;
    } else {
        document.getElementById('practitionerNotesField').style.display = 'none';
    }
    
    // Show/hide practitioner section
    document.getElementById('practitionerSection').style.display = hasPractitionerInfo ? 'block' : 'none';
    
    // Show modal
    document.getElementById('assessmentModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeAssessmentModal() {
    document.getElementById('assessmentModal').style.display = 'none';
    document.body.style.overflow = '';
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAssessmentModal();
        closeFindingsModal();
    }
});

// Findings Modal Functions
function showFindingsModal(assessmentId) {
    const modal = document.getElementById('findingsModal');
    const modalContent = document.getElementById('findingsModalContent');
    
    // Show loading state
    modalContent.innerHTML = '<div style="text-align: center; padding: 2rem;"><p>Loading findings...</p></div>';
    modal.style.display = 'block';
    
    // Fetch findings via AJAX
    fetch(`/assessments/${assessmentId}/findings/json/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                modalContent.innerHTML = `<div style="text-align: center; padding: 2rem;"><p style="color: red;">${data.error}</p></div>`;
                return;
            }
            
            // Build findings HTML
            let html = `
                <div class="findings-modal-header">
                    <h2>Extracted Findings</h2>
                    <span class="badge badge-primary">${data.findings_count} finding${data.findings_count !== 1 ? 's' : ''}</span>
                </div>
                <div class="findings-modal-body">
                    <div class="findings-info">
                        <p><strong>Assessment Date:</strong> ${data.assessment_date}</p>
                    </div>
            `;
            
            if (data.findings_count === 0) {
                html += '<div class="empty-state"><p>No findings have been extracted yet.</p></div>';
            } else {
                for (const [category, findings] of Object.entries(data.findings_by_category)) {
                    html += `
                        <div class="findings-category">
                            <h3 class="category-title">${category}</h3>
                            <div class="table-responsive">
                                <table class="findings-table">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Finding</th>
                                            <th>Extracted</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    findings.forEach(finding => {
                        html += `
                            <tr class="${finding.is_verified ? 'finding-verified' : ''}">
                                <td>
                                    <span class="finding-type-badge finding-type-${finding.type_class}">
                                        ${finding.type}
                                    </span>
                                </td>
                                <td class="finding-text">${finding.text}</td>
                                <td class="finding-date">${finding.extracted_at}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            modalContent.innerHTML = html;
        })
        .catch(error => {
            console.error('Error fetching findings:', error);
            modalContent.innerHTML = '<div style="text-align: center; padding: 2rem;"><p style="color: red;">Error loading findings. Please try again.</p></div>';
        });
}

function extractAndShowFindings(assessmentId) {
    const modal = document.getElementById('findingsModal');
    const modalContent = document.getElementById('findingsModalContent');
    
    // Show processing state
    modalContent.innerHTML = '<div style="text-align: center; padding: 2rem;"><p>Processing image and extracting findings... This may take a moment.</p><div class="spinner"></div></div>';
    modal.style.display = 'block';
    
    // Process the image first via AJAX
    fetch(`/assessments/${assessmentId}/process-notes/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(data => {
                    throw new Error(data.error || 'Failed to process image');
                });
            }
        })
        .then(data => {
            if (data.success) {
                // Successfully processed, now fetch and show findings
                setTimeout(() => {
                    showFindingsModal(assessmentId);
                }, 1000);
            } else {
                throw new Error(data.error || 'Processing failed');
            }
        })
        .catch(error => {
            console.error('Error processing image:', error);
            modalContent.innerHTML = `<div style="text-align: center; padding: 2rem;"><p style="color: red;">Error: ${error.message}</p><p>Please try again or check the image format.</p></div>`;
        });
}

function closeFindingsModal() {
    document.getElementById('findingsModal').style.display = 'none';
}
</script>

<!-- Findings Modal -->
<div id="findingsModal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeFindingsModal()"></div>
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h2>Extracted Findings</h2>
            <button type="button" class="modal-close" onclick="closeFindingsModal()">‚úï</button>
        </div>
        <div id="findingsModalContent" class="modal-body">
            <!-- Content loaded via AJAX -->
        </div>
    </div>
</div>

<style>
.findings-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
}

.findings-modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

.findings-info {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background-color: #f5f5f5;
    border-radius: 4px;
}

.findings-category {
    margin-bottom: 2rem;
}

.category-title {
    margin-bottom: 1rem;
    color: #333;
    font-size: 1.25rem;
    font-weight: 600;
}

.findings-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.findings-table th,
.findings-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.findings-table th {
    background-color: #f5f5f5;
    font-weight: 600;
    color: #333;
}

.findings-table tbody tr:hover {
    background-color: #f9f9f9;
}

.finding-verified {
    background-color: #f0f9ff;
}

.finding-text {
    max-width: 500px;
    word-wrap: break-word;
}

.finding-type-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
}

.finding-type-measurement {
    background-color: #e3f2fd;
    color: #1976d2;
}

.finding-type-strength {
    background-color: #fff3e0;
    color: #f57c00;
}

.finding-type-symptom {
    background-color: #fce4ec;
    color: #c2185b;
}

.finding-type-treatment {
    background-color: #e8f5e9;
    color: #388e3c;
}

.finding-type-observation {
    background-color: #f3e5f5;
    color: #7b1fa2;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #20B2AA;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 1rem auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
