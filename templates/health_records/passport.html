{% extends 'base.html' %}
{% load static %}

{% block title %}Health Passport - ShareMyCare{% endblock %}

{% block content %}
<div class="book-container">
    <div class="book-controls">
        <button class="book-btn prev-btn" onclick="turnPage(-1)" id="prevBtn">‚Üê Previous</button>
        <span class="page-indicator">
            <span id="currentPage">1</span> / <span id="totalPages">7</span>
        </span>
        <button class="book-btn next-btn" onclick="turnPage(1)" id="nextBtn">Next ‚Üí</button>
    </div>

    <div class="book-wrapper">
        <div class="book" id="healthBook">
            <!-- Cover Page -->
            <div class="page cover-page">
                <div class="page-content">
                    <div class="cover-design">
                        <div class="passport-title-large">HEALTH PASSPORT</div>
                        <div class="passport-subtitle-large">ShareMyCare</div>
                        <div class="cover-icon">üìò</div>
                        <div class="cover-name">{{ profile.user.get_full_name|default:profile.user.username }}</div>
                        {% if profile.date_of_birth %}
                            <div class="cover-dob">Born: {{ profile.date_of_birth|date:"F d, Y" }}</div>
                        {% endif %}
                        <div class="cover-stamp">OFFICIAL</div>
                    </div>
                </div>
            </div>

            <!-- Page 1: Personal Information -->
            <div class="page">
                <div class="page-content">
                    <div class="page-header">
                        <h2 class="page-title">Personal Information</h2>
                        <div class="page-number">1</div>
                    </div>
                    <div class="page-body">
                        <div class="info-section">
                            <div class="info-row">
                                <span class="info-label">Full Name:</span>
                                <span class="info-value">{{ profile.user.get_full_name|default:profile.user.username }}</span>
                            </div>
                            {% if profile.date_of_birth %}
                            <div class="info-row">
                                <span class="info-label">Date of Birth:</span>
                                <span class="info-value">{{ profile.date_of_birth|date:"F d, Y" }}</span>
                            </div>
                            {% endif %}
                            {% if profile.phone_number %}
                            <div class="info-row">
                                <span class="info-label">Phone:</span>
                                <span class="info-value">{{ profile.phone_number }}</span>
                            </div>
                            {% endif %}
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value">{{ profile.user.email }}</span>
                            </div>
                        </div>
                        
                        {% if profile.emergency_contact_name %}
                        <div class="info-section emergency-section">
                            <h3 class="section-title">Emergency Contact</h3>
                            <div class="info-row">
                                <span class="info-label">Name:</span>
                                <span class="info-value">{{ profile.emergency_contact_name }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Relationship:</span>
                                <span class="info-value">{{ profile.emergency_contact_relationship }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone:</span>
                                <span class="info-value emergency-phone">{{ profile.emergency_contact_phone }}</span>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="page-footer">
                            <a href="{% url 'health_records:edit_profile' %}" class="btn btn-primary btn-sm">Edit Profile</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Medications -->
            <div class="page">
                <div class="page-content">
                    <div class="page-header">
                        <h2 class="page-title">Current Medications</h2>
                        <div class="page-number">2</div>
                    </div>
                    <div class="page-body">
                        {% if medications %}
                            <div class="medications-list">
                                {% for med in medications %}
                                    <div class="medication-entry">
                                        <div class="entry-header">
                                            <strong class="med-name">{{ med.name }}</strong>
                                            {% if med.is_active %}
                                                <span class="status-badge active">Active</span>
                                            {% else %}
                                                <span class="status-badge inactive">Inactive</span>
                                            {% endif %}
                                        </div>
                                        <div class="entry-details">
                                            {% if med.dosage %}<span>Dosage: {{ med.dosage }}</span>{% endif %}
                                            {% if med.frequency %}<span>Frequency: {{ med.frequency }}</span>{% endif %}
                                            {% if med.is_prescribed %}
                                                <span class="prescribed-badge">Prescribed</span>
                                            {% else %}
                                                <span class="prescribed-badge non-prescribed">Non-prescribed</span>
                                            {% endif %}
                                        </div>
                                        {% if med.notes %}
                                            <p class="entry-notes">{{ med.notes }}</p>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state">
                                <div class="empty-icon">üíä</div>
                                <h3>No Medications Recorded</h3>
                                <p>You haven't added any medications yet. Add your medications to keep your health passport complete.</p>
                            </div>
                        {% endif %}
                        <div class="page-footer">
                            <a href="{% url 'health_records:add_medication' %}" class="btn btn-primary btn-sm">Add Medication</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 3: Medical Conditions -->
            <div class="page">
                <div class="page-content">
                    <div class="page-header">
                        <h2 class="page-title">Medical Conditions</h2>
                        <div class="page-number">3</div>
                    </div>
                    <div class="page-body">
                        {% if conditions %}
                            <div class="conditions-list">
                                {% for condition in conditions %}
                                    <div class="condition-entry">
                                        <div class="entry-header">
                                            <strong class="condition-name">{{ condition.name }}</strong>
                                            <span class="status-badge status-{{ condition.status }}">{{ condition.get_status_display }}</span>
                                        </div>
                                        {% if condition.diagnosis_date %}
                                            <div class="entry-details">
                                                <span>Diagnosed: {{ condition.diagnosis_date|date:"F Y" }}</span>
                                            </div>
                                        {% endif %}
                                        {% if condition.notes %}
                                            <p class="entry-notes">{{ condition.notes }}</p>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state">
                                <div class="empty-icon">üè•</div>
                                <h3>No Conditions Recorded</h3>
                                <p>You haven't added any medical conditions yet. Add your conditions to keep your health passport complete.</p>
                            </div>
                        {% endif %}
                        <div class="page-footer">
                            <a href="{% url 'health_records:add_condition' %}" class="btn btn-primary btn-sm">Add Condition</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: Allergies -->
            <div class="page">
                <div class="page-content">
                    <div class="page-header">
                        <h2 class="page-title">Allergies</h2>
                        <div class="page-number">4</div>
                    </div>
                    <div class="page-body">
                        {% if allergies %}
                            <div class="allergies-list">
                                {% for allergy in allergies %}
                                    <div class="allergy-entry severity-{{ allergy.severity }}">
                                        <div class="entry-header">
                                            <strong class="allergy-name">{{ allergy.allergen }}</strong>
                                            {% if allergy.severity %}
                                                <span class="severity-badge severity-{{ allergy.severity }}">
                                                    {{ allergy.get_severity_display }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        {% if allergy.reaction %}
                                            <div class="entry-details">
                                                <span><strong>Reaction:</strong> {{ allergy.reaction }}</span>
                                            </div>
                                        {% endif %}
                                        {% if allergy.date_identified %}
                                            <div class="entry-details">
                                                <span>Identified: {{ allergy.date_identified|date:"F Y" }}</span>
                                            </div>
                                        {% endif %}
                                        {% if allergy.notes %}
                                            <p class="entry-notes">{{ allergy.notes }}</p>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state">
                                <div class="empty-icon">‚ö†Ô∏è</div>
                                <h3>No Allergies Recorded</h3>
                                <p>You haven't added any allergies yet. It's important to record all known allergies for emergency situations.</p>
                            </div>
                        {% endif %}
                        <div class="page-footer">
                            <a href="{% url 'health_records:add_allergy' %}" class="btn btn-primary btn-sm">Add Allergy</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 5: Recent Assessments -->
            <div class="page">
                <div class="page-content">
                    <div class="page-header">
                        <h2 class="page-title">Recent Assessments</h2>
                        <div class="page-number">5</div>
                    </div>
                    <div class="page-body">
                        {% if assessments %}
                            <div class="assessments-list">
                                {% for assessment in assessments %}
                                    <div class="assessment-entry">
                                        <div class="entry-header">
                                            <strong>{{ assessment.assessment_date|date:"F d, Y"|default:"Recent Assessment" }}</strong>
                                            {% if assessment.assessment_type %}
                                                <span class="type-badge">{{ assessment.get_assessment_type_display }}</span>
                                            {% endif %}
                                        </div>
                                        {% if assessment.clinician %}
                                            <div class="entry-details">
                                                <span>By: {{ assessment.clinician.full_name }}</span>
                                            </div>
                                        {% endif %}
                                        {% if assessment.objective_findings %}
                                            <p class="entry-notes">{{ assessment.objective_findings|truncatewords:30 }}</p>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state">
                                <div class="empty-icon">üìã</div>
                                <h3>No Assessments Recorded</h3>
                                <p>You haven't added any health assessments yet. Add assessments to track your health over time.</p>
                            </div>
                        {% endif %}
                        <div class="page-footer">
                            <a href="{% url 'health_records:add_assessment' %}" class="btn btn-primary btn-sm">Add Assessment</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back Cover -->
            <div class="page cover-page back-cover">
                <div class="page-content">
                    <div class="cover-design">
                        <div class="cover-icon">üìò</div>
                        <div class="cover-stamp">ShareMyCare</div>
                        <div class="cover-footer">
                            <p>Your Digital Health Passport</p>
                            <p>Keep this information up to date</p>
                        </div>
                        <div class="cover-qr-placeholder">
                            <div class="qr-icon">üì±</div>
                            <p>QR Code</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="book-actions">
        <a href="{% url 'health_records:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        <a href="{% url 'health_records:emergency_card' %}" class="btn btn-primary">Emergency Card</a>
    </div>
</div>

<style>
.book-container {
    max-width: 100%;
    margin: 2rem auto;
    padding: 0 1rem;
    padding-bottom: 100px;
}

.book-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.book-btn {
    padding: 0.75rem 1.5rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.book-btn:hover:not(:disabled) {
    background: var(--primary-hover);
    transform: translateY(-2px);
}

.book-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-indicator {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    min-width: 80px;
    text-align: center;
}

.book-wrapper {
    perspective: 2000px;
    margin: 2rem 0;
    display: flex;
    justify-content: center;
}

.book {
    width: 800px;
    height: 600px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s;
}

.page {
    position: absolute;
    width: 100%;
    height: 100%;
    background: #f5f5f5;
    border: 1px solid #ddd;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    transform-origin: left center;
    transition: transform 0.6s ease, opacity 0.3s ease;
    backface-visibility: hidden;
    left: 0;
    top: 0;
    display: block;
}

.page-content {
    width: 100%;
    height: 100%;
    padding: 2rem;
    overflow-y: auto;
    background: white;
}

/* Cover Pages */
.cover-page {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
}

.cover-page .page-content {
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cover-design {
    text-align: center;
    width: 100%;
}

.passport-title-large {
    font-size: 2.5rem;
    font-weight: 700;
    letter-spacing: 4px;
    margin-bottom: 1rem;
    text-transform: uppercase;
}

.passport-subtitle-large {
    font-size: 1.5rem;
    margin-bottom: 2rem;
    opacity: 0.9;
}

.cover-icon {
    font-size: 5rem;
    margin: 2rem 0;
}

.cover-name {
    font-size: 1.75rem;
    font-weight: 600;
    margin: 1.5rem 0;
}

.cover-dob {
    font-size: 1.125rem;
    opacity: 0.9;
    margin-bottom: 2rem;
}

.cover-stamp {
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: 3px;
    border: 3px solid white;
    padding: 0.75rem 2rem;
    display: inline-block;
    margin-top: 2rem;
}

.back-cover {
    background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
}

.cover-footer {
    margin-top: 3rem;
    font-size: 1rem;
    opacity: 0.9;
}

.cover-qr-placeholder {
    margin-top: 3rem;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    display: inline-block;
}

.qr-icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}

/* Regular Pages */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.page-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.page-number {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.page-body {
    min-height: 400px;
}

.info-section {
    margin-bottom: 2rem;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--bg-light);
}

.info-label {
    font-weight: 600;
    color: var(--text-secondary);
}

.info-value {
    color: var(--text-primary);
    text-align: right;
}

.emergency-section {
    background: #fff3cd;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
    margin-top: 2rem;
}

.emergency-phone {
    color: #dc3545;
    font-weight: 700;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

/* Lists */
.medications-list,
.conditions-list,
.allergies-list,
.assessments-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.medication-entry,
.condition-entry,
.allergy-entry,
.assessment-entry {
    padding: 1.25rem;
    background: var(--bg-light);
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

.entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.entry-details {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    font-size: 0.9375rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.entry-notes {
    margin-top: 0.75rem;
    font-size: 0.9375rem;
    color: var(--text-primary);
    line-height: 1.6;
}

.status-badge,
.severity-badge,
.type-badge,
.prescribed-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-badge.active {
    background: #4caf50;
    color: white;
}

.status-badge.inactive {
    background: #9e9e9e;
    color: white;
}

.severity-badge.severity-mild {
    background: #fff3cd;
    color: #856404;
}

.severity-badge.severity-moderate {
    background: #ffeaa7;
    color: #d63031;
}

.severity-badge.severity-severe {
    background: #ff6b6b;
    color: white;
}

.prescribed-badge {
    background: #e3f2fd;
    color: #1976d2;
}

.prescribed-badge.non-prescribed {
    background: #f3e5f5;
    color: #7b1fa2;
}

.allergy-entry.severity-severe {
    border-left-color: #dc3545;
    background: #ffe5e5;
}

.page-footer {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
    text-align: center;
}

.empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-secondary);
    min-height: 300px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 0.75rem 0;
}

.empty-state p {
    font-size: 0.9375rem;
    line-height: 1.6;
    max-width: 400px;
    margin: 0;
    color: var(--text-secondary);
}

.book-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    flex-wrap: wrap;
}

/* Page Turning Animation - handled by JavaScript */

@media (max-width: 1024px) {
    .book {
        width: 100%;
        max-width: 600px;
        height: 500px;
    }
}

@media (max-width: 768px) {
    .book {
        height: 400px;
    }
    
    .page-content {
        padding: 1.5rem;
    }
    
    .passport-title-large {
        font-size: 2rem;
    }
    
    .page-title {
        font-size: 1.5rem;
    }
}
</style>

<script>
let currentPageIndex = 0;
const totalPages = 7; // Cover + 5 content pages + back cover = 7 pages total
const pages = document.querySelectorAll('.page');

document.getElementById('totalPages').textContent = totalPages;

function updatePageDisplay() {
    // Show page number (1-indexed for user display)
    document.getElementById('currentPage').textContent = currentPageIndex + 1;
    
    // Update button states
    document.getElementById('prevBtn').disabled = currentPageIndex === 0;
    document.getElementById('nextBtn').disabled = currentPageIndex >= totalPages - 1;
    
    // Show all pages, but only the current one is fully visible
    pages.forEach((page, index) => {
        if (index === currentPageIndex) {
            // Current page - fully visible
            page.style.display = 'block';
            page.style.opacity = '1';
            page.style.transform = 'rotateY(0deg)';
            page.style.zIndex = totalPages;
            page.classList.remove('turned');
        } else if (index < currentPageIndex) {
            // Pages before current - turned/hidden
            page.style.display = 'block';
            page.style.opacity = '0.3';
            page.style.transform = 'rotateY(-180deg)';
            page.style.zIndex = totalPages - (currentPageIndex - index);
            page.classList.add('turned');
        } else {
            // Pages after current - hidden
            page.style.display = 'block';
            page.style.opacity = '0';
            page.style.transform = 'rotateY(0deg)';
            page.style.zIndex = totalPages - (index - currentPageIndex);
            page.classList.remove('turned');
        }
    });
}

function turnPage(direction) {
    const newIndex = currentPageIndex + direction;
    if (newIndex >= 0 && newIndex < totalPages) {
        currentPageIndex = newIndex;
        updatePageDisplay();
    }
}

// Initialize
updatePageDisplay();

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        turnPage(-1);
    } else if (e.key === 'ArrowRight') {
        turnPage(1);
    }
});

// Touch swipe support
let touchStartX = 0;
let touchEndX = 0;

document.querySelector('.book-wrapper').addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
});

document.querySelector('.book-wrapper').addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    if (touchEndX < touchStartX - 50) {
        turnPage(1); // Swipe left - next page
    }
    if (touchEndX > touchStartX + 50) {
        turnPage(-1); // Swipe right - previous page
    }
}
</script>
{% endblock %}
