{% extends 'base.html' %}
{% load static %}

{% block title %}Practitioner Dashboard - ShareMyCare{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Practitioner Dashboard</h1>
        <p class="dashboard-subtitle">Welcome, {{ clinician.full_name }}!</p>
    </div>

    <div class="practitioner-info-card">
        <div class="practitioner-info-header">
            <h2>Your Information</h2>
            <div class="practitioner-info-actions">
                <a href="{% url 'clinicians:edit_profile' %}" class="btn btn-primary btn-sm">Edit</a>
                <a href="{% url 'clinicians:delete_profile' %}" class="btn btn-danger btn-sm">Delete</a>
            </div>
        </div>
        <div class="info-grid">
            <div class="info-item">
                <strong>Title:</strong> {{ clinician.get_title_display }}
            </div>
            <div class="info-item">
                <strong>Speciality:</strong> {{ clinician.speciality|default:"Not specified" }}
            </div>
            <div class="info-item">
                <strong>Organisation:</strong> {{ clinician.organisation|default:"Not specified" }}
            </div>
            <div class="info-item">
                <strong>Registration Number:</strong> {{ clinician.registration_number|default:"Not specified" }}
            </div>
            <div class="info-item" style="grid-column: 1 / -1; padding: var(--spacing-md); background: linear-gradient(135deg, rgba(0, 113, 227, 0.1) 0%, rgba(32, 178, 170, 0.1) 100%); border-radius: var(--radius-md); border: 2px solid rgba(0, 113, 227, 0.2);">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--spacing-sm);">
                    <div>
                        <strong style="display: block; margin-bottom: 0.25rem; color: var(--text-primary);">Your Practitioner Code:</strong>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">
                            Share this code with patients so they can connect with you instantly
                        </p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; letter-spacing: 0.5rem; color: var(--primary-color); font-family: 'Courier New', monospace; padding: var(--spacing-sm) var(--spacing-md); background: white; border-radius: var(--radius-md); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            {{ clinician.practitioner_code|default:"Generating..." }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        {% if patients_with_assessments %}
            {% for patient_data in patients_with_assessments %}
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title-group">
                            <div class="card-icon-emoji">ğŸ‘¤</div>
                            <div>
                                <h2 class="card-title">{{ patient_data.patient.get_full_name|default:patient_data.patient.username }}</h2>
                                <p class="card-count">{{ patient_data.assessments.count }} assessment{{ patient_data.assessments.count|pluralize }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        {% if patient_data.assessments %}
                            <div class="items-list">
                                {% for assessment in patient_data.assessments|slice:":5" %}
                                    <div class="item-row">
                                        <div class="item-info">
                                            <h4>
                                                Assessment 
                                                {% if assessment.assessment_date %}
                                                    - {{ assessment.assessment_date|date:"d M Y" }}
                                                {% elif assessment.symptom_date %}
                                                    - {{ assessment.symptom_date|date:"d M Y" }}
                                                {% elif assessment.created_at %}
                                                    - {{ assessment.created_at|date:"d M Y" }}
                                                {% endif %}
                                                {% if assessment.completed_at %}
                                                    <span style="font-size: 0.875rem; font-weight: normal; color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                                                        Completed: {{ assessment.completed_at|date:"d M Y H:i" }}
                                                    </span>
                                                {% endif %}
                                            </h4>
                                            <p class="item-details">
                                                {% if assessment.has_user_symptoms %}
                                                    <strong>Patient Symptoms:</strong>
                                                    {% if assessment.current_symptoms %}
                                                        {{ assessment.current_symptoms|truncatewords:15 }}
                                                    {% endif %}
                                                    {% if assessment.pain_level is not None %}
                                                        â€¢ Pain Level: {{ assessment.pain_level }}/10
                                                    {% endif %}
                                                {% endif %}
                                            </p>
                                            <div class="item-badges">
                                                {% if assessment.has_user_symptoms %}
                                                    <span class="badge badge-info">Patient Symptoms</span>
                                                {% endif %}
                                                {% if assessment.has_practitioner_data %}
                                                    <span class="badge badge-success">Practitioner Data</span>
                                                {% endif %}
                                                {% if assessment.objective_measures %}
                                                    <span class="badge badge-primary">Objective Measures</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="item-actions">
                                            {% if assessment.has_practitioner_data %}
                                                <a href="{% url 'health_records:edit_practitioner_assessment' assessment.pk %}" class="btn-icon" title="Edit Assessment">ğŸ“</a>
                                            {% else %}
                                                <a href="{% url 'health_records:add_practitioner_assessment' assessment.pk %}" class="btn-icon" title="Complete Assessment">âœ…</a>
                                            {% endif %}
                                            {% if assessment.objective_measures %}
                                                <a href="{% url 'clinicians:edit_objective_measures' assessment.objective_measures.pk %}" class="btn-icon" title="Edit Objective Measures">ğŸ“Š</a>
                                            {% else %}
                                                <a href="{% url 'clinicians:add_objective_measures' assessment.pk %}" class="btn-icon" title="Add Objective Measures">â•</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state">
                                <p>No assessments yet for this patient.</p>
                            </div>
                        {% endif %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                            <a href="{% url 'clinicians:create_assessment' patient_data.patient.id %}" class="btn btn-primary btn-sm" style="display: inline-block;">
                                {% if clinician.title == 'physiotherapist' %}
                                    â• Create Physiotherapy Assessment
                                {% else %}
                                    â• Create New Assessment
                                {% endif %}
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% elif patient_accesses %}
            {# Fallback: Show patients from patient_accesses if patients_with_assessments is empty #}
            {% for access in patient_accesses %}
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title-group">
                            <div class="card-icon-emoji">ğŸ‘¤</div>
                            <div>
                                <h2 class="card-title">{{ access.patient.get_full_name|default:access.patient.username }}</h2>
                                <p class="card-count">0 assessments</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="empty-state">
                            <p>No assessments yet for this patient.</p>
                        </div>
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                            <a href="{% url 'clinicians:create_assessment' access.patient.id %}" class="btn btn-primary btn-sm" style="display: inline-block;">
                                {% if clinician.title == 'physiotherapist' %}
                                    â• Create Physiotherapy Assessment
                                {% else %}
                                    â• Create New Assessment
                                {% endif %}
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title-group">
                        <div class="card-icon-emoji">ğŸ‘¥</div>
                        <div>
                            <h2 class="card-title">Your Patients</h2>
                            <p class="card-count">0 patients</p>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="empty-state">
                        <p>No patients have granted you access yet.</p>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            Patients can invite you via email to access their health records.
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

