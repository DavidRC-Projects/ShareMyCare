{% extends 'base.html' %}
{% load static %}

{% block title %}Create Assessment - ShareMyCare{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <h1 class="form-title">
                {% if is_physiotherapist %}
                    Create Physiotherapy Assessment
                {% else %}
                    Create New Assessment
                {% endif %}
            </h1>
            <a href="{% url 'clinicians:dashboard' %}" class="btn-close">‚úï</a>
        </div>
        
        <div class="patient-info-box">
            <p><strong>Patient:</strong> {{ patient.get_full_name|default:patient.username }}</p>
        </div>
        
        {# Quick Photo and Quick Upload buttons at the top #}
        <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
            <label style="display: block; margin-bottom: 1rem; font-weight: 600; font-size: 1rem;">üì∑ Photo of Notes (Optional)</label>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                {# Hidden input for form submission #}
                <input type="file" name="{{ form.practitioner_notes_image.name }}" id="{{ form.practitioner_notes_image.id_for_label }}" class="form-file-input" accept="image/*" style="display: none;">
                
                {# Quick Photo button - triggers camera #}
                <input type="file" id="take_photo_input" accept="image/*" capture="environment" onchange="handleImageUpload(this, '{{ form.practitioner_notes_image.id_for_label }}')" style="display: none;">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('take_photo_input').click(); return false;" style="flex: 1; min-width: 150px; padding: 0.75rem 1.5rem; font-size: 1rem;">
                    üì∑ Quick Photo
                </button>
                
                {# Quick Upload button - triggers file picker #}
                <input type="file" id="choose_file_input" accept="image/*" onchange="handleImageUpload(this, '{{ form.practitioner_notes_image.id_for_label }}')" style="display: none;">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('choose_file_input').click()" style="flex: 1; min-width: 150px; padding: 0.75rem 1.5rem; font-size: 1rem;">
                    üìÅ Quick Upload
                </button>
            </div>
            <div id="image-upload-feedback" style="display: none; margin-top: 1rem; padding: 1rem; background-color: #e8f5e9; border-radius: 4px; border: 1px solid #4caf50;">
                <p style="margin: 0; color: #2e7d32; font-weight: 500;">‚úì Image selected successfully!</p>
                <p id="image-filename" style="margin: 0.5rem 0 0 0; color: #2e7d32; font-size: 0.9rem;"></p>
            </div>
            <div id="image-preview-container" style="display: none; margin-top: 1rem;">
                <p style="margin-bottom: 0.5rem; font-weight: 500;">Preview:</p>
                <img id="image-preview" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; background: #f9f9f9;">
            </div>
            {% if form.practitioner_notes_image.errors %}
                <span class="field-error" style="display: block; margin-top: 0.5rem;">{{ form.practitioner_notes_image.errors.0 }}</span>
            {% endif %}
            <p class="form-hint" style="margin-top: 0.5rem; margin-bottom: 0;">Take a photo or upload an image. Findings can be automatically extracted after saving.</p>
        </div>
        
        <form method="post" class="form" enctype="multipart/form-data" id="assessmentForm">
            {% csrf_token %}
            
            {# Hidden input to ensure assessment_type submits for physiotherapists #}
            {% if is_physiotherapist %}
                <input type="hidden" name="assessment_type" value="physiotherapy" id="assessment_type_hidden">
            {% endif %}
            
            {# Form Fields Section #}
            <div id="form-fields-section">
            {% if is_physiotherapist %}
                <h3 class="form-section-title">Subjective Assessment (Patient-Reported Symptoms)</h3>
                
                <div class="form-group">
                    <label for="{{ form.symptom_date.id_for_label }}">Symptom Date</label>
                    {{ form.symptom_date }}
                    {% if form.symptom_date.errors %}
                        <span class="field-error">{{ form.symptom_date.errors.0 }}</span>
                    {% endif %}
                    <p class="form-hint">Date when symptoms were reported</p>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.current_symptoms.id_for_label }}">Current Symptoms</label>
                    {{ form.current_symptoms }}
                    {% if form.current_symptoms.errors %}
                        <span class="field-error">{{ form.current_symptoms.errors.0 }}</span>
                    {% endif %}
                    <p class="form-hint">Current symptoms described by the patient</p>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.previous_symptoms.id_for_label }}">Previous Symptoms</label>
                    {{ form.previous_symptoms }}
                    {% if form.previous_symptoms.errors %}
                        <span class="field-error">{{ form.previous_symptoms.errors.0 }}</span>
                    {% endif %}
                    <p class="form-hint">Previous symptoms that have resolved or changed</p>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.condition_progression.id_for_label }}">Condition Progression</label>
                    {{ form.condition_progression }}
                    {% if form.condition_progression.errors %}
                        <span class="field-error">{{ form.condition_progression.errors.0 }}</span>
                    {% endif %}
                    <p class="form-hint">How the condition has progressed over time</p>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.pain_level.id_for_label }}">Pain Level (0-10)</label>
                    {{ form.pain_level }}
                    {% if form.pain_level.errors %}
                        <span class="field-error">{{ form.pain_level.errors.0 }}</span>
                    {% endif %}
                    <p class="form-hint">Pain level from 0 (no pain) to 10 (worst pain)</p>
                </div>
                
                {% if is_physiotherapist %}
                <div style="width: 100%; margin-top: 1rem; margin-bottom: 0.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="saveAndAddObjectiveMeasures()" style="flex: 0 0 auto;">
                        ‚ûï Add Detailed ROM & Strength
                    </button>
                    <p class="form-hint" style="margin-top: 0.5rem; margin-bottom: 0;">
                        Add detailed range of motion and strength measurements for all joints.
                    </p>
                </div>
                {% endif %}
                
                <h3 class="form-section-title" style="margin-top: 1rem;">Objective Assessment</h3>
            {% else %}
                <h3 class="form-section-title">Assessment Details</h3>
            {% endif %}
            
            <div class="form-row">
                <div class="form-group">
                    {% if is_physiotherapist %}
                        <label for="{{ form.assessment_type.id_for_label }}">Assessment Type</label>
                        {{ form.assessment_type }}
                        {% if form.assessment_type.errors %}
                            <span class="field-error">{{ form.assessment_type.errors.0 }}</span>
                        {% endif %}
                        <p class="form-hint">Automatically set to Physiotherapy</p>
                    {% else %}
                        <label for="{{ form.assessment_type.id_for_label }}">Assessment Type</label>
                        {{ form.assessment_type }}
                        {% if form.assessment_type.errors %}
                            <span class="field-error">{{ form.assessment_type.errors.0 }}</span>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.assessment_date.id_for_label }}">Assessment Date</label>
                    {{ form.assessment_date }}
                    {% if form.assessment_date.errors %}
                        <span class="field-error">{{ form.assessment_date.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group">
                <label for="{{ form.completed_at.id_for_label }}">Date & Time Completed</label>
                {{ form.completed_at }}
                {% if form.completed_at.errors %}
                    <span class="field-error">{{ form.completed_at.errors.0 }}</span>
                {% endif %}
                <p class="form-hint">When this assessment was completed</p>
            </div>
            
            <div class="form-group">
                <label for="{{ form.objective_findings.id_for_label }}">Objective Findings</label>
                {{ form.objective_findings }}
                {% if form.objective_findings.errors %}
                    <span class="field-error">{{ form.objective_findings.errors.0 }}</span>
                {% endif %}
                <p class="form-hint">Clinical findings and observations from your examination</p>
            </div>
            
            <div class="form-group">
                <label for="{{ form.treatment_plan.id_for_label }}">Treatment Plan</label>
                {{ form.treatment_plan }}
                {% if form.treatment_plan.errors %}
                    <span class="field-error">{{ form.treatment_plan.errors.0 }}</span>
                {% endif %}
                <p class="form-hint">Treatment plan and recommendations</p>
            </div>
            
            <div class="form-group">
                <label for="{{ form.practitioner_notes.id_for_label }}">Additional Notes</label>
                {{ form.practitioner_notes }}
                {% if form.practitioner_notes.errors %}
                    <span class="field-error">{{ form.practitioner_notes.errors.0 }}</span>
                {% endif %}
            </div>
            
            </div> {# End form-fields-section #}
            
            <div class="form-actions" style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                <button type="submit" class="btn btn-primary" style="flex: 0 0 auto;">
                    {% if is_physiotherapist %}
                        Save Assessment
                    {% else %}
                        Create Assessment
                    {% endif %}
                </button>
                <a href="{% url 'clinicians:dashboard' %}" class="btn btn-secondary" style="flex: 0 0 auto;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
// Handle disabled select field submission for physiotherapists
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('assessmentForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Check if form submission was already confirmed
            if (form.dataset.confirmed === 'true') {
                // Re-enable disabled fields so they submit, or use hidden input
                const disabledFields = form.querySelectorAll('select[disabled]');
                disabledFields.forEach(function(field) {
                    field.disabled = false;
                });
                return true; // Allow submission
            }
            
            // Prevent default submission to check for blank fields
            e.preventDefault();
            
            // Check for blank important fields
            const blankFields = [];
            const importantFields = [
                { name: 'symptom_date', label: 'Symptom Date', element: document.getElementById('{{ form.symptom_date.id_for_label }}') },
                { name: 'current_symptoms', label: 'Current Symptoms', element: document.getElementById('{{ form.current_symptoms.id_for_label }}') },
                { name: 'assessment_date', label: 'Assessment Date', element: document.getElementById('{{ form.assessment_date.id_for_label }}') },
                { name: 'completed_at', label: 'Date & Time Completed', element: document.getElementById('{{ form.completed_at.id_for_label }}') },
                { name: 'objective_findings', label: 'Objective Findings', element: document.getElementById('{{ form.objective_findings.id_for_label }}') },
                { name: 'treatment_plan', label: 'Treatment Plan', element: document.getElementById('{{ form.treatment_plan.id_for_label }}') }
            ];
            
            importantFields.forEach(function(field) {
                if (field.element && !field.element.value.trim()) {
                    blankFields.push(field.label);
                }
            });
            
            // If there are blank fields, show confirmation dialog
            if (blankFields.length > 0) {
                const fieldList = blankFields.join('\n‚Ä¢ ');
                const message = `The following fields have been left blank:\n\n‚Ä¢ ${fieldList}\n\nAre you sure you want to continue and save this assessment?`;
                
                if (confirm(message)) {
                    // User confirmed - mark as confirmed and submit
                    form.dataset.confirmed = 'true';
                    
                    // Re-enable disabled fields
                    const disabledFields = form.querySelectorAll('select[disabled]');
                    disabledFields.forEach(function(field) {
                        field.disabled = false;
                    });
                    
                    form.submit();
                } else {
                    // User cancelled - do nothing
                    return false;
                }
            } else {
                // All fields filled - submit directly
                form.dataset.confirmed = 'true';
                
                // Re-enable disabled fields
                const disabledFields = form.querySelectorAll('select[disabled]');
                disabledFields.forEach(function(field) {
                    field.disabled = false;
                });
                
                form.submit();
            }
        });
    }
});

// Function to save assessment and redirect to objective measures
function saveAndAddObjectiveMeasures() {
    const form = document.getElementById('assessmentForm');
    if (!form) return;
    
    // Mark as confirmed to skip the blank field check
    form.dataset.confirmed = 'true';
    
    // Create a hidden input to indicate we want to add objective measures after saving
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'add_objective_measures';
    hiddenInput.value = '1';
    form.appendChild(hiddenInput);
    
    // Submit the form
    form.submit();
}

// Handle image upload and preview
function handleImageUpload(input, targetInputId) {
    const feedbackDiv = document.getElementById('image-upload-feedback');
    const filenameDiv = document.getElementById('image-filename');
    const previewContainer = document.getElementById('image-preview-container');
    const previewImg = document.getElementById('image-preview');
    const targetInput = document.getElementById(targetInputId);

    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Sync the file to the hidden form input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        targetInput.files = dataTransfer.files;

        feedbackDiv.style.display = 'block';
        filenameDiv.textContent = `File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;

        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        feedbackDiv.style.display = 'none';
        previewContainer.style.display = 'none';
    }
}

</script>
{% endblock %}

