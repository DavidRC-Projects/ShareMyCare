{% extends 'base.html' %}
{% load static %}

{% block title %}Quick Note Upload - ShareMyCare{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <h1 class="form-title">Quick Assessment</h1>
            <a href="{% url 'clinicians:create_assessment' patient.id %}" class="btn-close">‚úï</a>
        </div>
        
        <div class="patient-info-box">
            <p><strong>Patient:</strong> {{ patient.get_full_name|default:patient.username }}</p>
        </div>
        
        {# Quick Photo and Quick Upload buttons at the top #}
        <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
            <label style="display: block; margin-bottom: 1rem; font-weight: 600; font-size: 1rem;">Photo of Notes *</label>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                {# Hidden input for form submission #}
                <input type="file" name="{{ form.practitioner_notes_image.name }}" id="{{ form.practitioner_notes_image.id_for_label }}" class="form-file-input" accept="image/*" required style="display: none;">
                
                {# Quick Photo button - triggers camera #}
                <input type="file" id="take_photo_input" accept="image/*" capture="environment" onchange="handleImageUpload(this, '{{ form.practitioner_notes_image.id_for_label }}')" style="display: none;">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('take_photo_input').click()" style="flex: 1; min-width: 150px; padding: 0.75rem 1.5rem; font-size: 1rem;">
                    üì∑ Quick Photo
                </button>
                
                {# Quick Upload button - triggers file picker #}
                <input type="file" id="choose_file_input" accept="image/*" onchange="handleImageUpload(this, '{{ form.practitioner_notes_image.id_for_label }}')" style="display: none;">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('choose_file_input').click()" style="flex: 1; min-width: 150px; padding: 0.75rem 1.5rem; font-size: 1rem;">
                    üìÅ Quick Upload
                </button>
            </div>
            <div id="image-upload-feedback" style="display: none; margin-top: 1rem; padding: 1rem; background-color: #e8f5e9; border-radius: 4px; border: 1px solid #4caf50;">
                <p style="margin: 0; color: #2e7d32; font-weight: 500;">‚úì Image selected successfully!</p>
                <p id="image-filename" style="margin: 0.5rem 0 0 0; color: #2e7d32; font-size: 0.9rem;"></p>
            </div>
            <div id="image-preview-container" style="display: none; margin-top: 1rem;">
                <p style="margin-bottom: 0.5rem; font-weight: 500;">Preview:</p>
                <img id="image-preview" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; background: #f9f9f9;">
            </div>
            {% if form.practitioner_notes_image.errors %}
                <span class="field-error" style="display: block; margin-top: 0.5rem;">{{ form.practitioner_notes_image.errors.0 }}</span>
            {% endif %}
        </div>
        
        <form method="post" class="form" enctype="multipart/form-data" id="quickUploadForm">
            {% csrf_token %}
            
            {# Hidden input to ensure assessment_type submits for physiotherapists #}
            {% if is_physiotherapist %}
                <input type="hidden" name="assessment_type" value="physiotherapy" id="assessment_type_hidden">
            {% endif %}
            
            {# Minimal required fields #}
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.assessment_date.id_for_label }}">Assessment Date *</label>
                    {{ form.assessment_date }}
                    {% if form.assessment_date.errors %}
                        <span class="field-error">{{ form.assessment_date.errors.0 }}</span>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="{{ form.completed_at.id_for_label }}">Date & Time Completed *</label>
                    {{ form.completed_at }}
                    {% if form.completed_at.errors %}
                        <span class="field-error">{{ form.completed_at.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>
            
            <input type="hidden" name="quick_save_with_image" value="1">
            
            <div class="form-actions" style="display: flex; gap: 1rem; justify-content: flex-start;">
                <button type="submit" class="btn btn-primary" style="flex: 0 0 auto;">
                    üíæ Save & Process Image
                </button>
                <a href="{% url 'clinicians:create_assessment' patient.id %}" class="btn btn-secondary" style="flex: 0 0 auto;">Fill in Full Details Instead</a>
            </div>
        </form>
    </div>
</div>

<script>
// Handle image upload feedback
function handleImageUpload(input, targetInputId) {
    const feedbackDiv = document.getElementById('image-upload-feedback');
    const filenameDiv = document.getElementById('image-filename');
    const previewContainer = document.getElementById('image-preview-container');
    const previewImg = document.getElementById('image-preview');
    const targetInput = document.getElementById(targetInputId);
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Sync the file to the hidden form input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        targetInput.files = dataTransfer.files;
        
        // Show feedback
        feedbackDiv.style.display = 'block';
        filenameDiv.textContent = `File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        // Hide feedback if no file selected
        feedbackDiv.style.display = 'none';
        previewContainer.style.display = 'none';
    }
}

// Show guidance modal
function showImageGuidanceModal() {
    const modal = document.getElementById('imageGuidanceModal');
    if (modal) {
        modal.style.display = 'block';
    }
}

function closeImageGuidanceModal() {
    const modal = document.getElementById('imageGuidanceModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Set default dates on page load
document.addEventListener('DOMContentLoaded', function() {
    const assessmentDate = document.getElementById('{{ form.assessment_date.id_for_label }}');
    const completedAt = document.getElementById('{{ form.completed_at.id_for_label }}');
    
    // Set today's date if not set
    if (assessmentDate && !assessmentDate.value) {
        const today = new Date().toISOString().split('T')[0];
        assessmentDate.value = today;
    }
    
    // Set current datetime if not set
    if (completedAt && !completedAt.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        completedAt.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
});
</script>

<!-- Image Guidance Modal -->
<div id="imageGuidanceModal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeImageGuidanceModal()"></div>
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>Quick Note Upload Feature</h2>
            <button type="button" class="modal-close" onclick="closeImageGuidanceModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <h3 style="margin-top: 0;">How It Works</h3>
            <ol style="line-height: 1.8;">
                <li><strong>Upload your notes:</strong> Take a photo or upload an image of your handwritten or typed notes.</li>
                <li><strong>Automatic processing:</strong> Our AI system extracts key findings from your notes using Azure Document Intelligence.</li>
                <li><strong>Standardised table:</strong> Findings are automatically organised into a standardised table by category (measurements, symptoms, treatments, etc.).</li>
                <li><strong>Quick save:</strong> Save immediately with just the image and required fields.</li>
            </ol>
            
            <h3 style="margin-top: 1.5rem;">Benefits</h3>
            <ul style="line-height: 1.8;">
                <li>Save time by avoiding manual data entry</li>
                <li>Ensure consistency with standardised findings format</li>
                <li>Reduce transcription errors</li>
                <li>Maintain complete records with original notes image</li>
            </ul>
            
            <h3 style="margin-top: 1.5rem;">Supported Formats</h3>
            <p>JPEG, PNG, and PDF files are supported. For best results, ensure your notes are clear and well-lit.</p>
        </div>
        <div class="modal-footer" style="padding: 1rem; border-top: 1px solid #e0e0e0; text-align: right;">
            <button type="button" class="btn btn-primary" onclick="closeImageGuidanceModal()">Got it</button>
        </div>
    </div>
</div>
{% endblock %}

